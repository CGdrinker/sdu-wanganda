# Project 3: 用circom实现poseidon2哈希算法的电路一、实验目标

1) poseidon2哈希算法参数参考参考文档1的Table1，用(n,t,d)=(256,3,5)或(256,2,5)

2）电路的公开输入用poseidon2哈希值，隐私输入为哈希原象，哈希算法的输入只考虑一个block即可。

3) 用Groth16算法生成证明

参考文档：

1\. poseidon2哈希算法https://eprint.iacr.org/2023/323.pdf

2\. circom说明文档https://docs.circom.io/

3\. circom电路样例 https://github.com/iden3/circomlib

# 二、实验原理

**（一）密码学哈希函数​**

密码学哈希函数是一种将任意长度的输入数据映射为固定长度输出的函数，具有单向性、抗碰撞性和抗原像性等重要特性。它在密码学领域有着广泛的应用，如数据完整性验证、数字签名、密钥派生等。单向性指给定哈希结果，难以反推出原始输入；抗碰撞性指难以找到两个不同的输入得到相同的哈希结果；抗原像性指对于给定的哈希结果，难以找到对应的原始输入。​

**（二）Poseidon2 哈希算法​**

Poseidon2 哈希算法是一种基于海绵结构的哈希算法。海绵结构主要包括吸收阶段和挤压阶段。在吸收阶段，输入数据被分成固定长度的块，依次与算法的内部状态进行运算，将数据 “吸收” 到状态中；在挤压阶段，从内部状态中按照一定的规则提取出所需长度的哈希结果，完成数据的 “挤压” 过程。​

Poseidon2 算法的核心是置换函数，置换函数通过多轮操作对内部状态进行变换，每一轮操作主要包括以下三个步骤：​

ARK（AddRoundConstant，添加轮常数）：将轮常数添加到内部状态的各个元素中，轮常数是预先定义的一系列常数，其作用是增加算法的随机性和安全性。​

S-Box（Substitution Box，非线性变换）：对内部状态的元素进行非线性变换，本实验中采用的是非线性变换为 x⁵，非线性变换能够增强算法的混淆能力，使输入与输出之间的关系更加复杂，提高算法的安全性。​

MDS（MixColumns，线性扩散层）：通过线性变换矩阵对内部状态进行扩散操作，将一个元素的变化扩散到整个状态，使得输入的微小变化能够对输出产生较大的影响，保证算法的扩散性。​

本实验中使用的参数为 (n,t,d)=(256,3,5)，其中 n 表示哈希结果的位数为 256 位，t 表示状态宽度为 3（两个输入 + 1 个容量），d 表示 S-box 指数为 5。总轮数为 64 轮，包括首尾各 4 轮的完整轮和中间 56 轮的部分轮。完整轮中所有元素都应用 S-box 变换，部分轮中只有第一个元素应用 S-box 变换。​

**（三）Groth16 算法​**

Groth16 是一种高效的零知识证明算法，属于非交互式零知识证明系统。它能够在不泄露秘密信息的情况下，向验证者证明某个命题是正确的。在本实验中，使用 Groth16 算法生成证明，以证明 prover 知道哈希原象（隐私输入），使得其哈希结果等于公开输入的哈希值，而无需泄露隐私输入的具体内容。Groth16 算法具有证明大小小、验证速度快等优势，非常适合在区块链等资源受限的环境中应用。

# 三、实验思路

**（一）电路输入输出定义​**

电路的隐私输入为两个 256 位字段元素，即哈希原象；公开输入为哈希结果，即 256 位的 Poseidon2 哈希值。​

**（二）核心组件设计​**

S-Box 组件：实现非线性变换 x⁵，这是 Poseidon2 算法中的关键非线性操作，为算法提供混淆能力。​

轮处理组件（Poseidon2Round）：实现 Poseidon2 算法的单轮操作，根据轮类型（完整轮或部分轮）应用对应的 S-box 变换，同时完成 ARK 和 MDS 操作。​

主哈希电路（Poseidon2Hash）：初始化状态为 \[in1, in2, 0\]，然后依次连接 64 轮处理组件，其中前 4 轮和后 4 轮为完整轮，中间 56 轮为部分轮，最后输出最终状态的第一个元素作为哈希值。​

主电路：将两个隐私输入设为隐私信号，哈希结果设为公开信号，并添加约束确保公开信号与计算出的哈希值一致，集成 Groth16 模板生成证明。​

**（三）参数设置​**

硬编码 MDS 矩阵和轮常数，这些参数是根据 Poseidon2 算法规范确定的，用于保证算法的安全性和正确性。

# 四、重要实验部件

**（一）S-Box 组件​**

S-Box 组件实现了 x⁵的非线性变换，它是 Poseidon2 算法中提供非线性特性的核心部件。通过非线性变换，使得算法对输入的敏感性增强，能够有效抵抗线性攻击等密码分析方法，提高算法的安全性。在完整轮中，所有状态元素都会经过 S-Box 变换；在部分轮中，只有第一个状态元素经过 S-Box 变换。​

**（二）轮常数和 MDS 矩阵​**

轮常数：在 ARK 步骤中添加到内部状态，轮常数的引入增加了算法的随机性，使得不同轮次的操作具有差异性，避免了规律性攻击，提高了算法的安全性。​

MDS 矩阵：在 MDS 步骤中对内部状态进行线性扩散操作，它能够将内部状态中一个元素的变化扩散到整个状态，确保输入的微小变化能够在经过几轮变换后影响到输出的所有位，保证了算法的扩散性，使得哈希结果能够充分反映输入的特征。​

**（三）轮处理组件（Poseidon2Round）​**

轮处理组件是实现 Poseidon2 算法单轮操作的核心部件，它整合了 ARK、S-Box 和 MDS 三个步骤。对于完整轮，对所有状态元素应用 S-Box 变换；对于部分轮，只对第一个状态元素应用 S-Box 变换。通过多轮的轮处理操作，不断对内部状态进行混淆和扩散，最终得到能够反映输入特征的哈希结果。​

**（四）主哈希电路（Poseidon2Hash）​**

主哈希电路负责整个 Poseidon2 哈希算法的流程控制。它首先初始化内部状态，然后按照规定的轮数和轮类型依次调用轮处理组件，完成对输入数据的吸收和变换过程，最后从最终的内部状态中提取出哈希结果。主哈希电路是连接各个组件、实现完整哈希计算的关键。

# 五、实验流程

**1、定义 S-Box 组件：**使用 Circom 语言编写 S-Box 组件，实现 x⁵的非线性变换，接收一个输入信号，输出变换后的结果。​

**2、定义轮常数和 MDS 矩阵：**在代码中硬编码轮常数和 MDS 矩阵，这些参数需要根据 Poseidon2 算法规范生成正确的值。​

**3、实现轮处理组件：**轮处理组件接收当前状态、轮常数、轮类型等参数，先进行 ARK 操作（添加轮常数），再根据轮类型进行 S-Box 变换，最后进行 MDS 操作（线性扩散），输出变换后的状态。​

**4、实现主哈希电路（Poseidon2Hash）：**主哈希电路接收两个隐私输入，初始化状态为 \[in1, in2, 0\]，然后依次调用 4 轮完整轮处理组件、56 轮部分轮处理组件和 4 轮完整轮处理组件，最后输出最终状态的第一个元素作为哈希值。​

**5、构建主电路：**主电路实例化主哈希电路，将两个输入设为隐私信号，哈希结果设为公开信号，并添加约束确保公开信号与计算出的哈希值一致，集成 Groth16 模板生成证明。

# 六、实验具体过程

**1、准备工作：**替换代码中的轮常数和MDS 矩阵为根据 Poseidon2 规范生成的正确值，确保算法的正确性和安全性。​

**2、编译电路：**使用 Circom 编译器编译电路，执行命令circom poseidon2.circom --r1cs --wasm --sym，生成 r1cs 文件、wasm 文件和 sym 文件等。​

**3、生成证明和验证密钥：**使用 snarkjs 工具生成 Groth16 算法所需的证明密钥和验证密钥，为后续生成证明和验证证明做准备。

**4、准备输入文件：**创建 input.json 文件，包含两个隐私输入和预期的哈希结果，隐私输入为两个 256 位字段元素，哈希结果可以通过其他可靠的 Poseidon2 实现计算得到。​

**5、生成见证：**使用生成的 wasm 文件和 input.json 文件生成见证，执行命令snarkjs wtns calculate poseidon2_js/poseidon2.wasm input.json witness.wtns。​

**6、生成证明：**使用证明密钥和见证生成证明，执行相关的 snarkjs 命令。​

**7、验证证明：**使用验证密钥、公开信号和证明进行验证，检查证明是否有效。

# 七、实验结果

使用 input.json 文件中的隐私输入生成见证，见证生成成功，且从见证中提取的哈希值与 input.json 文件中预期的哈希值一致，说明电路的哈希计算功能正确。​成功生成了 Groth16 证明和验证密钥，使用证明密钥和见证生成了证明，然后使用验证密钥对证明进行验证，验证结果为成功，表明证明有效，即能够在不泄露隐私输入的情况下，证明隐私输入的哈希结果等于公开输入的哈希值。

# 八、实验总结

通过本次实验，我深入理解了 Poseidon2 哈希算法的原理和实现方式，包括海绵结构、置换函数中的 ARK、S-Box 和 MDS 步骤，以及完整轮和部分轮的区别。掌握了使用 Circom 语言构建密码学电路的方法，学会了如何设计核心组件、整合电路流程，并将 Groth16 零知识证明算法与哈希电路相结合，实现了隐私输入的哈希证明功能。​